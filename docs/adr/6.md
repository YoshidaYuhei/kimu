# ADR-0001: React Native CLI プロジェクトの初期設定

## ステータス
Proposed

## コンテキスト

iOS向けの新規React Nativeアプリ開発において、開発効率、コード品質、保守性を確保するための包括的な開発環境が必要である。

### 背景
- TypeScriptベースの型安全な開発環境が求められる
- コード品質とフォーマットの一貫性を保証する必要がある
- 単体テスト、E2Eテスト、カバレッジレポートを含む包括的なテスト戦略が必要
- 継続的インテグレーション/デプロイメントの自動化が不可欠

### 要件
Issue #6 で定義された以下の設定項目を実装する：
1. TypeScript設定（tsconfig.json、型定義、strict mode）
2. ESLint/Prettier設定（lint-staged、husky）
3. テスト環境（Jest、React Native Testing Library、Detox、カバレッジ）
4. CI/CD（GitHub Actions）

## 決定内容

### アーキテクチャパターン
**Feature-based構造**を採用する。

```
src/
├── features/
│   ├── auth/
│   │   ├── components/
│   │   ├── screens/
│   │   ├── hooks/
│   │   └── types/
│   └── dashboard/
│       ├── components/
│       ├── screens/
│       └── hooks/
├── shared/
│   ├── components/
│   ├── hooks/
│   └── utils/
├── navigation/
└── store/
```

機能ごとにディレクトリを分割し、各機能に関連するコンポーネント、画面、フック、型定義を同じディレクトリ内に配置する。共通部分はsharedディレクトリに集約する。

### 技術選択

#### 状態管理: Zustand
- 軽量でシンプル、学習コストが低い
- TypeScript親和性が高い
- React Native Testing Libraryとの相性が良い

#### ナビゲーション: React Navigation v6
- React Nativeで最も人気があり実績豊富
- TypeScript完全サポート
- 豊富なドキュメントとコミュニティ

#### TypeScript設定
- `strict: true`を有効化（標準的な厳格さ）
- 以下のオプションを設定：
  ```json
  {
    "compilerOptions": {
      "strict": true,
      "target": "esnext",
      "module": "commonjs",
      "jsx": "react-native",
      "moduleResolution": "node",
      "esModuleInterop": true,
      "skipLibCheck": true,
      "resolveJsonModule": true,
      "allowSyntheticDefaultImports": true
    }
  }
  ```

#### ESLint/Prettier
- **ベース**: `@react-native/eslint-config`（React Native公式推奨）
- **Prettier**: デフォルト設定を使用
- **Pre-commit hooks**: lint-staged + huskyで以下を実行
  - ESLint自動修正
  - Prettier自動フォーマット
  - TypeScript型チェック

#### テスト戦略

**単体テスト（Jest + React Native Testing Library）**
- コンポーネント、hooks、ユーティリティ関数をテスト
- カバレッジ目標: 80%以上（CIで強制）
- 設定：
  ```json
  {
    "coverageThreshold": {
      "global": {
        "branches": 80,
        "functions": 80,
        "lines": 80,
        "statements": 80
      }
    }
  }
  ```

**E2Eテスト（Detox）**
- React Native専用、グレーボックステスト
- 主要なユーザーフローを網羅
- iOS Simulatorで実行

**スナップショットテスト**
- UI変更検知に使用
- 重要なコンポーネントのみに限定

#### CI/CD戦略（GitHub Actions）

**PRワークフロー**
- リント/型チェック（全PR）
- 単体テスト実行（全PR）
- カバレッジチェック（80%未満で失敗）

**mainブランチワークフロー**
- 上記に加えて以下を実行：
  - iOSビルド検証
  - E2Eテスト（Detox）

ビルドはmainブランチのみで実行することで、CI実行時間を最適化する。

## 結果

### 利点

1. **開発効率**
   - TypeScript strictモードによる早期エラー検出
   - Feature-based構造による機能の独立性と並行開発の容易さ
   - Zustandのシンプルさによる学習コストの低減

2. **コード品質**
   - ESLint + Prettierによる一貫したコードスタイル
   - Pre-commit hooksによる品質の自動保証
   - 80%以上のテストカバレッジ強制

3. **保守性**
   - Feature-based構造による変更の影響範囲の限定
   - 包括的なテストによるリファクタリングの安全性
   - TypeScriptによる自己文書化

4. **スケーラビリティ**
   - 機能単位での分割による拡張性
   - Zustandの軽量さによるパフォーマンス維持
   - React Navigation v6の柔軟性

### 欠点・トレードオフ

1. **学習コスト**
   - 新メンバーがZustand、Detox、GitHub Actionsなど複数のツールを学ぶ必要がある
   - Feature-based構造の慣習を理解する時間が必要

2. **初期セットアップコスト**
   - すべての設定ファイルの作成と調整に時間がかかる
   - Detoxの設定は複雑で試行錯誤が必要

3. **CI実行時間**
   - 全テスト + カバレッジチェックでPRフィードバックが若干遅延
   - Detoxは実行時間が長い（mainブランチのみで緩和）

4. **厳格なルールによる開発速度への影響**
   - 80%カバレッジ強制により、迅速なプロトタイピングが制約される可能性
   - strictモードが初期開発で手間に感じる場合がある

### 影響範囲

この設計決定は以下の範囲に影響する：

1. **開発フロー**
   - コーディング: TypeScript strict、ESLint、Prettierに従う
   - コミット: Pre-commit hooksが自動実行
   - PR: リント、型チェック、テスト、カバレッジがCI検証
   - マージ後: mainでビルド + E2Eテスト実行

2. **パフォーマンス**
   - Zustandの軽量さによりバンドルサイズ削減
   - Feature-based構造でコード分割が容易
   - React Navigation v6の最適化

3. **保守性**
   - 将来の機能追加: Feature-basedにより影響範囲が明確
   - リファクタリング: TypeScript + 高カバレッジで安全性向上
   - バグ修正: テストによる早期発見と回帰防止

## 代替案

### 状態管理の代替案

**Redux Toolkit**を検討したが採用しなかった。

- **理由**: 小〜中規模アプリにはオーバースペック
- **欠点**: ボイラープレートが多く、学習コストが高い
- **Zustandの優位性**: シンプルさ、TypeScript親和性、十分な機能

**Context API + hooks**は検討したが採用しなかった。

- **理由**: アプリが成長するとパフォーマンス問題が発生しやすい
- **Zustandの優位性**: セレクタによる最適化、ミドルウェアサポート

### E2Eテストの代替案

**Appium**を検討したが採用しなかった。

- **理由**: React Nativeでは設定と実行が重い
- **Detoxの優位性**: React Native専用設計、グレーボックステスト、実行速度

### アーキテクチャの代替案

**Atomic Design**を検討したが採用しなかった。

- **理由**: コンポーネントの分類（atoms/molecules/organisms）が曖昧で議論の余地がある
- **Feature-basedの優位性**: 機能ごとの明確な境界、並行開発の容易さ

## 参照

- Issue #6: https://github.com/YoshidaYuhei/kimu/issues/6
- React Navigation: https://reactnavigation.org/
- Zustand: https://github.com/pmndrs/zustand
- Detox: https://wix.github.io/Detox/
- React Native TypeScript: https://reactnative.dev/docs/typescript

## 履歴

- 2025-10-28: Proposed
